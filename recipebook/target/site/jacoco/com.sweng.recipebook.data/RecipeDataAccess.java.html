<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecipeDataAccess.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">recipebook</a> &gt; <a href="index.source.html" class="el_package">com.sweng.recipebook.data</a> &gt; <span class="el_source">RecipeDataAccess.java</span></div><h1>RecipeDataAccess.java</h1><pre class="source lang-java linenums">package com.sweng.recipebook.data;

import java.sql.Blob;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import com.sweng.recipebook.models.IngredientComposite;
import com.sweng.recipebook.models.Recipe;
import com.sweng.recipebook.models.RecipeMediaComposite;
import com.sweng.recipebook.models.ReviewComposite;
import com.sweng.recipebook.models.SharedRecipe;

/**
 * RecipeDataAccess - DataAccess class for application recipes.
 */
public class RecipeDataAccess extends DataAccess {

    public RecipeDataAccess() {
<span class="fc" id="L21">        super();</span>
<span class="fc" id="L22">    }</span>

    /**
     * addFavoriteRecipe - Method to add a favorite recipe to the favorites table.
     * 
     * @param userId   - User id number.
     * @param recipeId - Recipe id number.
     * @throws SQLException
     */
    public void addFavoriteRecipe(int userId, int recipeId) throws SQLException {
<span class="fc" id="L32">        String dml = &quot;MERGE INTO recipebook_favorite_recipes r USING ( SELECT ? AS user_id, ? AS recipe_id FROM dual) a ON (a.user_id = r.user_id AND a.recipe_id = r.recipe_id) WHEN NOT MATCHED THEN INSERT (user_id, recipe_id) VALUES (a.user_id, a.recipe_id)&quot;;</span>
<span class="fc" id="L33">        PreparedStatement statement = connection.prepareStatement(dml);</span>
        try {
<span class="fc" id="L35">            statement.setInt(1, userId);</span>
<span class="fc" id="L36">            statement.setInt(2, recipeId);</span>
<span class="fc" id="L37">            statement.execute();</span>
<span class="fc" id="L38">        } finally {</span>
<span class="fc" id="L39">            statement.close();</span>
        }
<span class="fc" id="L41">    }</span>

    /**
     * addRecipe - Method to add a recipe to the recipes table.
     * 
     * @param recipe - Recipe to be added.
     * @param userId - User id adding the recipe.
     * @return - Added recipe id int.
     * @throws SQLException // this.correctJSONCharacters(
     */
    public int addRecipe(Recipe recipe, int userId) throws SQLException {
<span class="fc" id="L52">        String dml = &quot;INSERT INTO recipebook_recipes (recipe_name, recipe_description, serving_size, instructions, user_id) VALUES (?, ?, ?, ?, ?)&quot;;</span>
<span class="fc" id="L53">        PreparedStatement statement = connection.prepareStatement(dml);</span>
<span class="fc" id="L54">        Blob blob = connection.createBlob();</span>
        try {
<span class="fc" id="L56">            blob.setBytes(1, this.correctJSONCharacters(recipe.getInstructions()).getBytes());</span>
<span class="fc" id="L57">            statement.setString(1, this.correctJSONCharacters(recipe.getRecipeName()));</span>
<span class="fc" id="L58">            statement.setString(2, this.correctJSONCharacters(recipe.getRecipeDescription()));</span>
<span class="fc" id="L59">            statement.setInt(3, recipe.getServingSize());</span>
<span class="fc" id="L60">            statement.setBlob(4, blob);</span>
<span class="fc" id="L61">            statement.setInt(5, userId);</span>
<span class="fc" id="L62">            statement.execute();</span>
<span class="fc" id="L63">        } finally {</span>
<span class="fc" id="L64">            statement.close();</span>
        }
<span class="fc" id="L66">        return getRecipeId(recipe.getRecipeName(), userId);</span>
    }

    /**
     * getHomeRecipes - Method to retrieve recipes for showcasing on the home page.
     * 
     * @return - List of Recipes.
     * @throws SQLException
     */
    public List&lt;Recipe&gt; getHomeRecipes() throws SQLException {
<span class="fc" id="L76">        List&lt;Recipe&gt; result = new ArrayList&lt;Recipe&gt;();</span>
<span class="fc" id="L77">        String query = &quot;SELECT recipe_id, recipe_name, recipe_description FROM recipebook_recipes ORDER BY recipe_id&quot;;</span>
<span class="fc" id="L78">        PreparedStatement statement = connection.prepareStatement(query);</span>
        try {
<span class="fc" id="L80">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L82">                result.add(new SharedRecipe(resultSet.getInt(&quot;recipe_id&quot;), resultSet.getString(&quot;recipe_name&quot;),</span>
<span class="fc" id="L83">                        resultSet.getString(&quot;recipe_description&quot;), 0, &quot;&quot;, new IngredientComposite()));</span>
            }
<span class="fc" id="L85">        } finally {</span>
<span class="fc" id="L86">            statement.close();</span>
        }
<span class="fc" id="L88">        return result;</span>
    }

    /**
     * getFavoriteRecipeIds - Method to retrieve favorite recipe ids for a given
     * user id number.
     * 
     * @param userId - User id number.
     * @return - List of favorite recipe ids.
     * @throws SQLException
     */
    public List&lt;Integer&gt; getFavoriteRecipeIds(int userId) throws SQLException {
<span class="fc" id="L100">        List&lt;Integer&gt; result = new ArrayList&lt;Integer&gt;();</span>
<span class="fc" id="L101">        String query = &quot;SELECT recipe_id FROM recipebook_favorite_recipes WHERE user_id = ?&quot;;</span>
<span class="fc" id="L102">        PreparedStatement statement = connection.prepareStatement(query);</span>
        try {
<span class="fc" id="L104">            statement.setInt(1, userId);</span>
<span class="fc" id="L105">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L107">                result.add(resultSet.getInt(&quot;recipe_id&quot;));</span>
            }
<span class="fc" id="L109">        } finally {</span>
<span class="fc" id="L110">            statement.close();</span>
        }
<span class="fc" id="L112">        return result;</span>
    }

    /**
     * getRecipe - Method to retrieve a recipe for a given id number.
     * 
     * @param recipeId             - Recipe id number.
     * @param ingredientComposite  - Recipe ingredients.
     * @param recipeMediaComposite - Recipe media.
     * @return - Recipe for the given id number.
     * @throws SQLException
     */
    public SharedRecipe getRecipe(int recipeId, IngredientComposite ingredientComposite,
            RecipeMediaComposite recipeMediaComposite, ReviewComposite reviewComposite) throws SQLException {
<span class="fc" id="L126">        SharedRecipe result = new SharedRecipe();</span>
<span class="fc" id="L127">        String query = &quot;SELECT recipe_id, recipe_name, recipe_description, serving_size, instructions, user_id AS shared_by_id, first_name || ' ' || SUBSTR(last_name, 1, 1) || '.' AS shared_by_name FROM recipebook_recipes JOIN recipebook_user USING (user_id) WHERE recipe_id = ?&quot;;</span>
<span class="fc" id="L128">        PreparedStatement statement = connection.prepareStatement(query);</span>
        try {
<span class="fc" id="L130">            statement.setInt(1, recipeId);</span>
<span class="fc" id="L131">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L133">                result = new SharedRecipe(resultSet.getInt(&quot;recipe_id&quot;), resultSet.getString(&quot;recipe_name&quot;),</span>
<span class="fc" id="L134">                        resultSet.getString(&quot;recipe_description&quot;), resultSet.getInt(&quot;serving_size&quot;),</span>
<span class="fc" id="L135">                        new String(resultSet.getBytes(&quot;instructions&quot;)), ingredientComposite, recipeMediaComposite,</span>
<span class="fc" id="L136">                        resultSet.getString(&quot;shared_by_name&quot;), resultSet.getInt(&quot;shared_by_id&quot;), reviewComposite);</span>
            }
<span class="fc" id="L138">        } finally {</span>
<span class="fc" id="L139">            statement.close();</span>
        }
<span class="fc" id="L141">        return result;</span>
    }

    /**
     * getRecipeId - Method to retrieve the recipe id for the given recipe and user
     * id.
     * 
     * @param recipeName - Shared recipe.
     * @param userId     - User id of shared recipe.
     * @return - Recipe id int.
     * @throws SQLException
     */
    public int getRecipeId(String recipeName, int userId) throws SQLException {
<span class="fc" id="L154">        int result = 0;</span>
<span class="fc" id="L155">        String query = &quot;SELECT recipe_id FROM recipebook_recipes WHERE user_id = ? AND recipe_name = ?&quot;;</span>
<span class="fc" id="L156">        PreparedStatement statement = connection.prepareStatement(query);</span>
        try {
<span class="fc" id="L158">            statement.setInt(1, userId);</span>
<span class="fc" id="L159">            statement.setString(2, this.correctJSONCharacters(recipeName));</span>
<span class="fc" id="L160">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L162">                result = resultSet.getInt(&quot;recipe_id&quot;);</span>
            }
<span class="fc" id="L164">        } finally {</span>
<span class="fc" id="L165">            statement.close();</span>
        }
<span class="fc" id="L167">        return result;</span>
    }

    /**
     * isFavoriteRecipe - Method to test if a given recipe id for a user id is a
     * favorite.
     * 
     * @param recipeId - Recipe id number.
     * @param userId   - User id number.
     * @return - True if favorite, otherwise false.
     * @throws SQLException
     */
    public boolean isFavoriteRecipe(int recipeId, int userId) throws SQLException {
<span class="fc" id="L180">        String query = &quot;SELECT recipe_id, user_id FROM recipebook_favorite_recipes WHERE recipe_id = ? AND user_id = ?&quot;;</span>
<span class="fc" id="L181">        PreparedStatement statement = connection.prepareStatement(query);</span>
        try {
<span class="fc" id="L183">            statement.setInt(1, recipeId);</span>
<span class="fc" id="L184">            statement.setInt(2, userId);</span>
<span class="fc" id="L185">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc" id="L186">            return resultSet.isBeforeFirst();</span>
        } finally {
<span class="fc" id="L188">            statement.close();</span>
        }
    }

    /**
     * isUserRecipe - Method to test if a given recipe id was shared by the user id.
     * 
     * @param recipeId - Recipe id number.
     * @param userId   - User id number.
     * @return - True if it is the user's recipe, otherwise false.
     * @throws SQLException
     */
    public boolean isUserRecipe(int recipeId, int userId) throws SQLException {
<span class="fc" id="L201">        String query = &quot;SELECT recipe_id, user_id FROM recipebook_recipes WHERE recipe_id = ? AND user_id = ?&quot;;</span>
<span class="fc" id="L202">        PreparedStatement statement = connection.prepareStatement(query);</span>
        try {
<span class="fc" id="L204">            statement.setInt(1, recipeId);</span>
<span class="fc" id="L205">            statement.setInt(2, userId);</span>
<span class="fc" id="L206">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc" id="L207">            return resultSet.isBeforeFirst();</span>
        } finally {
<span class="fc" id="L209">            statement.close();</span>
        }
    }

    /**
     * removeFavoriteRecipe - Method to remove a favorite recipe from the favorites
     * table.
     * 
     * @param userId   - User id number.
     * @param recipeId - Recipe id number.
     * @throws SQLException
     */
    public void removeFavoriteRecipe(int userId, int recipeId) throws SQLException {
<span class="fc" id="L222">        String dml = &quot;DELETE FROM recipebook_favorite_recipes WHERE user_id = ? AND recipe_id = ?&quot;;</span>
<span class="fc" id="L223">        PreparedStatement statement = connection.prepareStatement(dml);</span>
        try {
<span class="fc" id="L225">            statement.setInt(1, userId);</span>
<span class="fc" id="L226">            statement.setInt(2, recipeId);</span>
<span class="fc" id="L227">            statement.execute();</span>
<span class="fc" id="L228">        } finally {</span>
<span class="fc" id="L229">            statement.close();</span>
        }
<span class="fc" id="L231">    }</span>

    /**
     * removeRecipe - Method to remove a recipe from the application recipe table.
     * 
     * @param userId - Recipe id number to be removed.
     * @throws SQLException
     */
    public void removeRecipe(int recipeId) throws SQLException {
<span class="fc" id="L240">        String dml = &quot;DELETE FROM recipebook_recipes WHERE recipe_id = ?&quot;;</span>
<span class="fc" id="L241">        PreparedStatement statement = connection.prepareStatement(dml);</span>
        try {
<span class="fc" id="L243">            statement.setInt(1, recipeId);</span>
<span class="fc" id="L244">            statement.executeUpdate();</span>
<span class="fc" id="L245">        } finally {</span>
<span class="fc" id="L246">            statement.close();</span>
        }
<span class="fc" id="L248">    }</span>

    /**
     * updateRecipe - Method to update a recipe in the recipe table.
     * 
     * @param recipeId - Recipe id number to be updated.
     * @param recipe   - Recipe information.
     * @throws SQLException
     */
    public void updateRecipe(int recipeId, Recipe recipe) throws SQLException {
<span class="fc" id="L258">        String dml = &quot;UPDATE recipebook_recipes SET recipe_description = ?, serving_size = ?, instructions = ? WHERE recipe_id = ?&quot;;</span>
<span class="fc" id="L259">        PreparedStatement statement = connection.prepareStatement(dml);</span>
<span class="fc" id="L260">        Blob blob = connection.createBlob();</span>
        try {
<span class="fc" id="L262">            blob.setBytes(1, this.correctJSONCharacters(recipe.getInstructions()).getBytes());</span>
<span class="fc" id="L263">            statement.setString(1, this.correctJSONCharacters(recipe.getRecipeDescription()));</span>
<span class="fc" id="L264">            statement.setInt(2, recipe.getServingSize());</span>
<span class="fc" id="L265">            statement.setBlob(3, blob);</span>
<span class="fc" id="L266">            statement.setInt(4, recipeId);</span>
<span class="fc" id="L267">            statement.execute();</span>
<span class="fc" id="L268">        } finally {</span>
<span class="fc" id="L269">            statement.close();</span>
        }
<span class="fc" id="L271">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>